# PADD
Торговая система для MetaTrader 5, которая использует торговлю от уровней, образованных фракталами, после дивергенции с RSI.

* Разработчик: Denis Kislitsyn | denis@kislitsyn.me | [kislitsyn.me](https://kislitsyn.me)
* Версия: 1.08

## Что нового?

#### ==Версия v1.08 от 2024-09-08==

- [ ] 1. Повторные сделки
- [x] 2. **Обязательное пробитие уровня от касания до свечи ОН** включается параметром `DV.LHF.TD.E`.
- [x] 3. **Запрещены дивергенции, где свечи цены пересекают сегменты линий дивергенции**.
- [x] 4. **Запрещены конвергенции, где свечи цены пересекают сегменты линии конвергенции**.
- [x] 5. Добавлен **фильтр дивергенций/конвергенций по мин. наклону сегментов на ценовом графике.** Для этого применяется мин. расстояние ATR между вершинами дивергенции/конвергенции на графике цены. Задается настройками `ATR.DP.E` `ATR.DP.R`. Если дистанция между соседними вершинами меньше `ATR*ATR.DP.R`, то бот игнорирует дивергенцию/конвергенцию. Значение ATR берется по свече конца сегмента дивергенции/конвергенции. Для многосегментных дивергенций/конвергенций в расчете участвуют ATR свечей концов каждого сегмента.
- [x] 6. **Фильтр по мин. расстоянию в % между соседними вершинами дивергенции/конвергенции на RSI.** Включить фильтр настройкой `RSI.DP.E`. Установить мин. допустимое значение - `RSI.DP.V`.
- [x] 7. Запретить пробитие уровня от касания до конца дивергенции. Требование убрали, заменив на противоположенное в п.12.
- [x] 8. **Потенциальный вход в позицию в момент ограниченный временным фильтром инвалидирует уровень**. Теперь образование новых дивергенций/конвергенций стало невозможным от уровней, которые аннулированы потенциальными входами в запрещенное время.
- [x] 9. **Ретест уровня**. Теперь после образования сетапа бот установит новый уровень, в зависимости от настроек ретеста в группе `5. РЕТЕСТ (RT)`. После его касания бот войдет в позицию.
- [x] 10. **Режим проверки разрешенных диапазонов RSI**: `Все вершины` или `Только последняя` задается параметром `DV.RSI.FM`.
    > ==**ВАЖНО:**==
    Теперь бот строит значительно больше дивергенций/конвергенций. Потому что он находит и те, что находятся вне ограничивающих диапазонов значений RSI. Только после того как нашел все возможные дивергенции/конвергенции, бот отфильтровывает те, что не входят в разрешенные диапазоны в соответствии режимом. Это изменение заметно замедлило работу бота.
- [x] 11. Теперь касание уровня бот определяет без учета спреда - всегда по Bid цене. Стрелку тоже рисует на Bid-цене. 
    > ==**ВАЖНО:**==
    Уровни SL и TP, а также цену входа, по-прежнему определяет брокер в зависимости от направления входа: Ask для покупок и Bid для продаж.
- [x] 12. Фильтр дивергенции по условию, чтобы **последняя свеча обязательна должна быть выше всех, начиная с касания** включается параметром `DV.HLB.E`.

#### 2024-08-05
- [x] Дивергенция и конвергенция отличаются для RES и SUP уровня:
    1. RES: Линии сходятся - конвергенция.
    2. RES: Линии расходятся - дивергенция.
    3. SUP: Линии сходятся - дивергенция.
    4. SUP: Линии расходятся - конвергенция.

#### 2024-07-28
- [x] 1. Исправлена ошибка. Стрелка появляется в конце периода, а не после образования дивера. Сет выше.
- [x] 2. Добавить раздельные настройки для определения дивергенции (сходящаяся) и конвергенции (расходящаяся).
- [x] 3. Добавлена функцию реверса стрелки и позиций.
- [x] 4. Мин. и макс. RSI.
- [x] 5. Поиск дивергенции в диапазоне коэффициент*атр от линии фрактала, и если дивергенция за пределами его, то вход невалиден.
- [x] 6. Добавить вход без дивергенции сразу после пробития уровня.


## Торговая стратегия

1. Бот использует кастомный индикатор поиска фракталов `PADD-Fractal-Ind`.
2. Каждый найденный фрактал образует уровень.
3. Бот ждет возврата цены в уровень, после чего ожидает образования дивергенции с RSI.
4. Если дивергенция образовалась в отведенное время, бот входит в позицию.
5. Входы могут быть отфильтрованы по некоторым условиям из настроек.


## Установка
1. Убедитесь, что ваш терминал MetaTrader 5 обновлен до последней версии. Для тестирования советников рекомендуется обновить терминал до самой последней бета-версии. Для этого запустите обновление из главного меню `Help->Check For Updates->Latest Beta Version`. На прошлых версиях советник может не запускаться, потому что скомпилирован на последней версии терминала. В этом случае вы увидите сообщения на вкладке `Journal` об этом.
2. Установите индикатор `PADD-Fractal-Ind` в ваш терминал. Для этого скопируйте файл индикатотра `*.ex5` в каталог данных терминала `MQL5\Indicators`.
3. Установите советник в ваш терминал. Для этого скопируйте файл бота `*.ex5` в каталог данных терминала `MQL5\Experts\`.
4. Бот использует динамическое обновление фильтра времени торговли из внешнего текстового файла. Для этого он мониторит его изменения, которые сразу принимает к исполнению. Для работы этого функции нужно дать дополнительное разрешения в вашем терминале в главном меню терминала `Tools->Options` на закладке `Expert Advisors` установите флажок `Allow DLL imports`.
4. Откройте график пары.
5. Переместите советника из окна Навигатор на график.
6. Установите в настройках бота на закладке `Common` галочку `Allow Auto Trading` и на закладке `Dependencies` галочку `Allow DLL imports`.
7. Включите режим автоторговли в терминале, нажав кнопку `Algo Trading` на главной панели инструментов.

## Настройки

##### 1. ВХОДЫ (EN)
- [x] `EN.E`: Открывать позиции?
- [x] `EN.MMT`: Тип расчета лота
- [x] `EN.MMV`: Значение для расчета лот
- [x] `EN.SLD`: Фиксированная дистанция SL, пункт
- [x] `EN.TPD`: Фиксированная дистанция TP, пункт
- [x] `EN.TPRR`: Мультипликатор RR для TP

##### 2. СТРЕЛКИ (ARR)
- [x] `ARR.E:` Рисовать стрелки?
- [x] `ARR.B.CD`: Код стрелки BUY
- [x] `ARR.B.CL`: Цвет стрелки BUY
- [x] `ARR.B.CD`: Код стрелки SELL
- [x] `ARR.B.CD`: Цвет стрелки SELL

##### 3.0. ФРАКТАЛЫ (F)
- [x] `F.FTF`: Timeframe фракталов
- [x] `F.LEX`: Срок действия уровня, мин
- [x] `F.LSP`: Доп. сдвиг уровня от фрактала, пункт

##### 3.1. ФРАКТАЛ ВЕРХ (FU)
- [x] `FU.E`: Фрактал включен?
- [x] `FU.LBC`: Свечей слева, шт
- [x] `FU.LHS`: HIGH свечей слева упорядочены
- [x] `FU.LLS`: LOW свечей слева упорядочены
- [x] `FU.RBC`: Свечей справа, шт
- [x] `FU.RHS`: HIGH свечей справа упорядочены
- [x] `FU.RLS`: LOW свечей справа упорядочены
- [x] `FU.ACD`: Код символа стрелки
- [x] `FU.ACL`: Цвет стрелки

##### 3.2. ФРАКТАЛ НИЗ (FD)
- [x] `FD.E`: Фрактал включен?
- [x] `ARR.R`: Реверс стрелок и сделок?
- [x] `FD.LBC`: Свечей слева, шт
- [x] `FD.LHS`: HIGH свечей слева упорядочены
- [x] `FD.LLS`: LOW свечей слева упорядочены
- [x] `FD.RBC`: Свечей справа, шт
- [x] `FD.RHS`: HIGH свечей справа упорядочены
- [x] `FD.RLS`: LOW свечей справа упорядочены
- [x] `FD.ACD`: Код символа стрелки
- [x] `FD.ACL`: Цвет стрелки

##### 4. ДИВЕРГЕНЦИЯ (DV)
- [x] `DV.DIV.M`: Режим дивергенции
    - [x] `Отключена`: Вход в сделку сразу после пробития уровня
    - [x] `Только дивергенция`: Вход в сделку только после образования *дивергенции*:
        - для уровня RES - линии расходятся;
        - для уровня SUP - линии сходятся.
    - [x] `Только конвергенция`: Вход в сделку только после образования *конвергенции*:
        - для уровня RES - линии сходятся;
        - для уровня SUP - линии расходятся.
    - [x] `Дивергенция и конвергенция`: Вход в сделку после образования дивергенции или конвергенции
- [x] `DV.DBL`: Timeframe дивергенции
- [x] `DV.DEX`: Срок ожидания дивергенция, мин
- [x] `DV.BB.MIN`: Мин. количество баров между вершинами RSI, шт
- [x] `DV.BB.MAX`: Макс. количество баров между вершинами RSI, шт
- [x] ==`DV.RSI.FM`: Режим фильтра вершин RSI: `Все вершины` или `Последняя вершина`==
- [x] `DV.SUP.RSI.MIN`: Мин. RSI для вершин поддержки
- [x] `DV.SUP.RSI.MAX`: Макс. RSI для вершин поддержки
- [x] `DV.RES.RSI.MIN`: Мин. RSI для вершин сопротивления
- [x] `DV.RES.RSI.MAX`: Макс. RSI для вершин сопротивления
- [x] `DV.MPC`: Мин. количество последовательных сегментов дивергенции. 1-одинарная, 2-двойная, 3-тройная и т.д. 
    > **ВАЖНО!** Больше 3-х выбирать только после тестирования, потому что рекурсивный алгоритм их поиска замедляется экспоненциально с ростом количества.
- [x] `DV.VA`: Разрешить разнонаправленные сегменты (\\/ или /\\). *Если отключены, то направления последующих сегментов должны совпадать с первым. Иначе сегменты могут быть разнонаправлен, но обязательно противоположены между графиком цены и RSI.*
- [x] `DV.LHF.LL.E`: Запретить пробитие уровня слева от дивергенции
- [x] `DV.LHF.LL.C`: Количество свечей слева для проверки пробития уровня
- [x] ==`DV.LHF.TD.E`: Обязательно пробитие уровня от касания до свечи обратного направления==
- [x] ==`DV.HLB.E`: Последняя свеча дивергенции обязательна должна быть выше всех, начиная с касания. Включенный фильтр проверяет сетап только для дивергенции. Поэтому для конвергенций он не применяется.==
- [x] `DV.NBE.E`: Использовать H/L соседней свечи цены для дивергенции. *Если включено, то линия дивергенции на графике определяется максимальным значением свечи пика/впадины RSI и соседней справа*.

##### ==5. РЕТЕСТ (RT)==
- [x] `RT.E`: Ретест включен?
- [x] `RT.IE`: Коэф. ATR размера свечи обратного направления для немедленного входа
- [x] `RT.NE`: Коэф. ATR размера свечи обратного направления для инвалидации уровня
- [x] `RT.BR`: Коэф. размера свечи обратного направления для ретест уровня (0.5=50%)
- [x] `RT.EXP`: Срок ожидания ретеста, мин

##### 5. RSI
- [x] `RSI.MAP`: RSI Период MA
- [x] `RSI.AP`: RSI Применять к цене
- [x] `RSI.DP.E`: Фильтр входа по мин. дистанции между вершинами RSI дивергенции
- [x] ==`RSI.DP.V`: Мин. дистанция между вершинами RSI дивергенции, %==

##### 6. ATR
- [x] `ATR.MAP`: Период MA
- [x] `ATR.BR.E`: Фильтр входа по H-L свечи обратного направления
- [x] `ATR.BR.R`: Мультипликатор ATR для свечи обратного направления
- [x] `ATR.LD.E`: Фильтр входа по дистанции от уровня до H/L старта дивергенции
- [x] `ATR.LD.R`: Мультипликатор ATR для дистанции от уровня до H/L старта дивергенции
- [x] `ATR.DP.E`: ==Фильтр входа по мин. дистанции между вершинами ценовой дивергенции==
- [x] `ATR.DP.R`: ==Мультипликатор ATR для дистанции между вершинами ценовой дивергенции==

##### 7. ФИЛЬТР ПО ВРЕМЕНИ
- [x] `TTI.E`: Фильтр времени включен? 
- [x] `TTI.FN`: Полное имя INI файла настроек фильтра по времени

##### 8. ДОПОЛНИТЕЛЬНЫЕ НАСТРОЙКИ
- [x] `Magic`: Идентификатор эксперта
- [x] `GP`: Префикс комментариев и графики
- [x] `MS.CE`: Comment Enable (turn off with no visual for speed)
- [x] `MS.CI`: Comment Interval update, sec
- [x] `MS.LL`: Log Level


